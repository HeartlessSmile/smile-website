<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="logo.svg"><title>插件机制 | 前端工程化详解</title><meta name="description" content="前端工程化详解;开箱即用的前端工程化方案;前端代码规范;使用过程中如碰到问题，请到Github进行提问。 https://github.com/HeartlessSmile/smile-website">
    <link rel="preload" href="/smile-website/assets/style-DwUpfuWI.css" as="style"><link rel="stylesheet" href="/smile-website/assets/style-DwUpfuWI.css">
    <link rel="modulepreload" href="/smile-website/assets/app-DzEwyuga.js"><link rel="modulepreload" href="/smile-website/assets/plugin.html-CW15DT9P.js">
    <link rel="prefetch" href="/smile-website/assets/index.html-DTymrOnS.js" as="script"><link rel="prefetch" href="/smile-website/assets/css.html-BrR0k2h6.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-DbUTmgvD.js" as="script"><link rel="prefetch" href="/smile-website/assets/framework-node.html-DG1RZuiK.js" as="script"><link rel="prefetch" href="/smile-website/assets/framework-sdk.html-ChwEanbk.js" as="script"><link rel="prefetch" href="/smile-website/assets/framework.html-D7z82-xu.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-BiWWTQPc.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-DocoNhdX.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-Xo6AoSqb.js" as="script"><link rel="prefetch" href="/smile-website/assets/cmd.html-CQs7GYHf.js" as="script"><link rel="prefetch" href="/smile-website/assets/code.html-CPe9iGys.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-DIgcS9WE.js" as="script"><link rel="prefetch" href="/smile-website/assets/plugin.html-BcKuQ1sg.js" as="script"><link rel="prefetch" href="/smile-website/assets/summary.html-JNQeMvZ6.js" as="script"><link rel="prefetch" href="/smile-website/assets/api.html-D0rQzswG.js" as="script"><link rel="prefetch" href="/smile-website/assets/cmd.html-C4h_M8sM.js" as="script"><link rel="prefetch" href="/smile-website/assets/code.html-Dfu89gut.js" as="script"><link rel="prefetch" href="/smile-website/assets/config.html-BrpM0KTY.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-BS8lyzuN.js" as="script"><link rel="prefetch" href="/smile-website/assets/usePlugin.html-D5jQjI-6.js" as="script"><link rel="prefetch" href="/smile-website/assets/base.html-Dt4zEtE8.js" as="script"><link rel="prefetch" href="/smile-website/assets/cmd.html-DnARQTJy.js" as="script"><link rel="prefetch" href="/smile-website/assets/config.html-C7tnbOKA.js" as="script"><link rel="prefetch" href="/smile-website/assets/engines.html-C8GOgqCL.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-4XAed1e-.js" as="script"><link rel="prefetch" href="/smile-website/assets/react.html-COSHzaQD.js" as="script"><link rel="prefetch" href="/smile-website/assets/vs.html-hk8p2cXN.js" as="script"><link rel="prefetch" href="/smile-website/assets/vue3.html-CjyB296Y.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-CmUTRbB6.js" as="script"><link rel="prefetch" href="/smile-website/assets/name.html-9HJq7n3e.js" as="script"><link rel="prefetch" href="/smile-website/assets/reset.html-fLYy801D.js" as="script"><link rel="prefetch" href="/smile-website/assets/write.html-ocdwX6Hl.js" as="script"><link rel="prefetch" href="/smile-website/assets/component-name.html-BqAy6yfM.js" as="script"><link rel="prefetch" href="/smile-website/assets/react.html-zkOj49UX.js" as="script"><link rel="prefetch" href="/smile-website/assets/vue.html-FYXkWRZy.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-DTHieTTE.js" as="script"><link rel="prefetch" href="/smile-website/assets/options.html-DtwJxaff.js" as="script"><link rel="prefetch" href="/smile-website/assets/annotation.html-BY_t0m-O.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-BgsvrJKn.js" as="script"><link rel="prefetch" href="/smile-website/assets/write.html-CC2-am_r.js" as="script"><link rel="prefetch" href="/smile-website/assets/difference.html-BN_JJya8.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-Cyd_nguH.js" as="script"><link rel="prefetch" href="/smile-website/assets/more.html-BTVFKDXB.js" as="script"><link rel="prefetch" href="/smile-website/assets/name.html-C2CHTqAW.js" as="script"><link rel="prefetch" href="/smile-website/assets/icon.html-D-BJveNn.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-C2JWwH8t.js" as="script"><link rel="prefetch" href="/smile-website/assets/package-management.html-B2otfLtT.js" as="script"><link rel="prefetch" href="/smile-website/assets/basics.html-ePmZBKUZ.js" as="script"><link rel="prefetch" href="/smile-website/assets/init.html-hfQ7Friz.js" as="script"><link rel="prefetch" href="/smile-website/assets/optimize.html-B-WgZgt8.js" as="script"><link rel="prefetch" href="/smile-website/assets/ast.html-HxCA_Hgs.js" as="script"><link rel="prefetch" href="/smile-website/assets/build.html-CTDqJSBo.js" as="script"><link rel="prefetch" href="/smile-website/assets/cli.html-B7yc5QRf.js" as="script"><link rel="prefetch" href="/smile-website/assets/debug.html-DZCwyv0j.js" as="script"><link rel="prefetch" href="/smile-website/assets/package.html-Dk_Q8bnh.js" as="script"><link rel="prefetch" href="/smile-website/assets/codeReview.html-F95ENn9t.js" as="script"><link rel="prefetch" href="/smile-website/assets/guide.html-DFRcBnNL.js" as="script"><link rel="prefetch" href="/smile-website/assets/lint.html-DHN1lluV.js" as="script"><link rel="prefetch" href="/smile-website/assets/ts.html-C_U629DD.js" as="script"><link rel="prefetch" href="/smile-website/assets/tsconfig.html-DMxS_6h2.js" as="script"><link rel="prefetch" href="/smile-website/assets/version.html-Di0sVWyr.js" as="script"><link rel="prefetch" href="/smile-website/assets/guide.html-Dt4jSha0.js" as="script"><link rel="prefetch" href="/smile-website/assets/module.html-BQHHubZ-.js" as="script"><link rel="prefetch" href="/smile-website/assets/basic.html-Ce-FicUk.js" as="script"><link rel="prefetch" href="/smile-website/assets/container.html-BfHu0gaR.js" as="script"><link rel="prefetch" href="/smile-website/assets/githubActions.html-ckwEoze4.js" as="script"><link rel="prefetch" href="/smile-website/assets/gitlabCI.html-Ct6cecI0.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-DfTrd3DC.js" as="script"><link rel="prefetch" href="/smile-website/assets/mode.html-BsqnvDR2.js" as="script"><link rel="prefetch" href="/smile-website/assets/canvas.html-BtrWegX8.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-CA-5pUfj.js" as="script"><link rel="prefetch" href="/smile-website/assets/miniProgram.html-DJXbB78Q.js" as="script"><link rel="prefetch" href="/smile-website/assets/native.html-Mzwykf5e.js" as="script"><link rel="prefetch" href="/smile-website/assets/use.html-CMRKVnNt.js" as="script"><link rel="prefetch" href="/smile-website/assets/web.html-Cjtz2NZz.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-DM_ZN5qz.js" as="script"><link rel="prefetch" href="/smile-website/assets/reuse.html-DmIBFDrb.js" as="script"><link rel="prefetch" href="/smile-website/assets/use.html-Di4e_CAv.js" as="script"><link rel="prefetch" href="/smile-website/assets/behaviour.html-DXAxWnWf.js" as="script"><link rel="prefetch" href="/smile-website/assets/blankScreen.html-DqeIhOXC.js" as="script"><link rel="prefetch" href="/smile-website/assets/error.html-DqgEYMHI.js" as="script"><link rel="prefetch" href="/smile-website/assets/jank.html-DQ6YzLgp.js" as="script"><link rel="prefetch" href="/smile-website/assets/performance.html-BXjvOgYV.js" as="script"><link rel="prefetch" href="/smile-website/assets/report.html-BnTGbNF2.js" as="script"><link rel="prefetch" href="/smile-website/assets/sentry.html-DCwhp_Ss.js" as="script"><link rel="prefetch" href="/smile-website/assets/build.html-BducVZU3.js" as="script"><link rel="prefetch" href="/smile-website/assets/performance.html-D8Lpw3XJ.js" as="script"><link rel="prefetch" href="/smile-website/assets/volume.html-BlqZRzY6.js" as="script"><link rel="prefetch" href="/smile-website/assets/attack.html-qoDRKejo.js" as="script"><link rel="prefetch" href="/smile-website/assets/resource.html-CCo1Pfx-.js" as="script"><link rel="prefetch" href="/smile-website/assets/documents.html-CDJHh-O3.js" as="script"><link rel="prefetch" href="/smile-website/assets/flow.html-BgiPejLP.js" as="script"><link rel="prefetch" href="/smile-website/assets/selection.html-CHOrFbHi.js" as="script"><link rel="prefetch" href="/smile-website/assets/standard.html-CgBBEd7y.js" as="script"><link rel="prefetch" href="/smile-website/assets/analysis.html-D2lzw4dz.js" as="script"><link rel="prefetch" href="/smile-website/assets/e2e.html-DCdUDs29.js" as="script"><link rel="prefetch" href="/smile-website/assets/integration.html-DzJqkfaW.js" as="script"><link rel="prefetch" href="/smile-website/assets/unit.html-B2VTTnks.js" as="script"><link rel="prefetch" href="/smile-website/assets/float.html-SwufCURd.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-CW-YcKbi.js" as="script"><link rel="prefetch" href="/smile-website/assets/int.html-BADWCyRN.js" as="script"><link rel="prefetch" href="/smile-website/assets/variable.html-Cs7YI72B.js" as="script"><link rel="prefetch" href="/smile-website/assets/hello.html-D7uLoLC4.js" as="script"><link rel="prefetch" href="/smile-website/assets/helloProject.html-SRU9u5FO.js" as="script"><link rel="prefetch" href="/smile-website/assets/ide.html-D8wo2iZa.js" as="script"><link rel="prefetch" href="/smile-website/assets/index.html-8357LED5.js" as="script"><link rel="prefetch" href="/smile-website/assets/install.html-IdheZBBu.js" as="script"><link rel="prefetch" href="/smile-website/assets/why.html-BJBqp8Dg.js" as="script"><link rel="prefetch" href="/smile-website/assets/browser.html-Ctt3fYnz.js" as="script"><link rel="prefetch" href="/smile-website/assets/vscode.html-2seD2tnJ.js" as="script"><link rel="prefetch" href="/smile-website/assets/404.html-5rFquv7X.js" as="script"><link rel="prefetch" href="/smile-website/assets/setupDevtools-7MC2TMWH-DLUMUa3z.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/smile-website/"><!----><span class="vp-site-name" aria-hidden="true">前端工程化详解</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/smile-website/project/" aria-label="工程化入门"><!---->工程化入门<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="工程化进阶"><span class="title">工程化进阶</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="工程化进阶"><span class="title">工程化进阶</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/smile-website/advanced/rollup/" aria-label="Rollup"><!---->Rollup<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/smile-website/advanced/esbuild/" aria-label="esbuild"><!---->esbuild<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/smile-website/advanced/vite/" aria-label="Vite"><!---->Vite<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/smile-website/guide/" aria-label="代码规范"><!---->代码规范<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://origin.duanhl.com/" aria-label="源码分析" rel="noopener noreferrer" target="_blank"><!---->源码分析<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/smile-website/monitor/" aria-label="前端监控系统"><!---->前端监控系统<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/HeartlessSmile/smile-website" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/smile-website/project/" aria-label="工程化入门"><!---->工程化入门<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="工程化进阶"><span class="title">工程化进阶</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="工程化进阶"><span class="title">工程化进阶</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/smile-website/advanced/rollup/" aria-label="Rollup"><!---->Rollup<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/smile-website/advanced/esbuild/" aria-label="esbuild"><!---->esbuild<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/smile-website/advanced/vite/" aria-label="Vite"><!---->Vite<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/smile-website/guide/" aria-label="代码规范"><!---->代码规范<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://origin.duanhl.com/" aria-label="源码分析" rel="noopener noreferrer" target="_blank"><!---->源码分析<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/smile-website/monitor/" aria-label="前端监控系统"><!---->前端监控系统<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/HeartlessSmile/smile-website" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading" href="/smile-website/advanced/rollup/" aria-label="Rollup 概述"><!---->Rollup 概述<!----></a><!----></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading"> <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/smile-website/advanced/rollup/cmd.html" aria-label="命令行调用"><!---->命令行调用<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/smile-website/advanced/rollup/code.html" aria-label="配置文件"><!---->配置文件<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/smile-website/advanced/rollup/config.html" aria-label="常用配置"><!---->常用配置<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/smile-website/advanced/rollup/api.html" aria-label="JavaScript API"><!---->JavaScript API<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/smile-website/advanced/rollup/usePlugin.html" aria-label="使用插件"><!---->使用插件<!----></a><!----></li><!--]--></ul></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/smile-website/advanced/rollup/plugin.html" aria-label="插件机制"><!---->插件机制<!----></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="插件机制" tabindex="-1"><a class="header-anchor" href="#插件机制"><span>插件机制</span></a></h1><h2 id="rollup插件概述" tabindex="-1"><a class="header-anchor" href="#rollup插件概述"><span>Rollup插件概述</span></a></h2><blockquote><p>Rollup 插件是一个对象，具有 <a href="https://cn.rollupjs.org/plugin-development/#properties" target="_blank" rel="noopener noreferrer">属性</a>、<a href="https://cn.rollupjs.org/plugin-development/#build-hooks" target="_blank" rel="noopener noreferrer">构建钩子</a> 和 <a href="https://cn.rollupjs.org/plugin-development/#output-generation-hooks" target="_blank" rel="noopener noreferrer">输出生成钩子</a> 中的一个或多个，并遵循我们的 <a href="https://cn.rollupjs.org/plugin-development/#conventions" target="_blank" rel="noopener noreferrer">约定</a>。插件应作为一个导出一个函数的包进行发布，该函数可以使用插件特定的选项进行调用并返回此类对象。</p></blockquote><p>简单来说，rollup插件一般会做成一个函数，函数返回一个对象，返回的对象中包含一些属性和不同阶段的钩子函数。</p><h3 id="约定" tabindex="-1"><a class="header-anchor" href="#约定"><span>约定</span></a></h3><p>插件应该有一个明确的名称，并以<code>rollup-plugin-</code>作为前缀。</p><h3 id="属性" tabindex="-1"><a class="header-anchor" href="#属性"><span>属性</span></a></h3><p>name：插件的名称，用于在警告和错误消息中标识插件。</p><p>version：插件的版本</p><h2 id="钩子函数的特点" tabindex="-1"><a class="header-anchor" href="#钩子函数的特点"><span>钩子函数的特点</span></a></h2><ul><li>钩子函数区分不同的调用时机</li><li>钩子函数是有执行顺序的</li><li>钩子函数有不同的执行方式</li><li>钩子函数也可以是对象的形式</li><li>对象形式的钩子函数可以改变钩子的执行，让不同插件的同名钩子函数获取不通的执行先后</li></ul><h3 id="钩子函数的调用时机" tabindex="-1"><a class="header-anchor" href="#钩子函数的调用时机"><span>钩子函数的调用时机</span></a></h3><p>这里的调用时机，其实就是以我们上面的API，build和output两大工作流的不同阶段进行分类。根据这两个不同阶段，rollup提供的不同的函数让我们调用</p><ul><li>const bundle = await rollup.rollup(inputOptions) 执行期间的构建钩子函数 - <a href="https://cn.rollupjs.org/plugin-development/#build-hooks" target="_blank" rel="noopener noreferrer">build-hooks</a></li><li>await bundle.generate(outputOptions)/write(outputOptions) 执行期间的输出钩子函数-<a href="https://cn.rollupjs.org/plugin-development/#output-generation-hooks" target="_blank" rel="noopener noreferrer">output-generation-hooks</a></li></ul><h3 id="钩子函数的执行方式" tabindex="-1"><a class="header-anchor" href="#钩子函数的执行方式"><span>钩子函数的执行方式</span></a></h3><p>除了上面简单的划分为两个阶段的调用时机之外，我们还可以以钩子函数的执行方式来分类。</p><ul><li><code>async/sync</code>：异步/同步钩子，async标记的钩子可以返回一个解析为相同类型的值的 Promise；否则，该钩子被标记为 <code>sync</code>。</li><li><code>first</code>：如果有多个插件实现此钩子，则钩子按顺序运行，直到钩子返回一个不是 <code>null</code> 或 <code>undefined</code> 的值。</li><li><code>sequential</code>：如果有多个插件实现此钩子，则所有这些钩子将按指定的插件顺序运行。如果钩子是 <code>async</code>，则此类后续钩子将等待当前钩子解决后再运行。</li><li><code>parallel</code>：如果有多个插件实现此钩子，则所有这些钩子将按指定的插件顺序运行。如果钩子是 <code>async</code>，则此类后续钩子将并行运行，而不是等待当前钩子。</li></ul><h3 id="钩子函数也可以是对象" tabindex="-1"><a class="header-anchor" href="#钩子函数也可以是对象"><span>钩子函数也可以是对象</span></a></h3><p>除了函数之外，钩子也可以是对象。在这种情况下，实际的钩子函数（或 <code>banner/footer/intro/outro</code> 的值）必须指定为 <code>handler</code>。这允许你提供更多的可选属性，以改变钩子的执行：</p><ul><li>order: &quot;pre&quot; | &quot;post&quot; | null</li></ul><p>如果有多个插件实现此钩子，则可以先运行此插件（<code>&quot;pre&quot;</code>），最后运行此插件（<code>&quot;post&quot;</code>），或在用户指定的位置运行（没有值或 <code>null</code>）。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">resolveFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;resolve-first&#39;</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">resolveId</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token string">&#39;pre&#39;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">				<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="构建钩子执行顺序" tabindex="-1"><a class="header-anchor" href="#构建钩子执行顺序"><span>构建钩子执行顺序</span></a></h3><p><img src="/smile-website/images/rollup/image-20230919180002325.png" alt="image-20230919180002325"></p><ol><li>通过 <code>options</code> 钩子读取配置，并进行配置的转换，得到处理后的配置对象</li><li>调用 <code>buildStart</code> 钩子，考虑了所有 <code>options</code>钩子配置的转换，包含未设置选项的正确默认值，正式开始构建流程</li><li>调用 <code>resolveId</code> 钩子解析模块文件路径。rollup中模块文件的id就是文件地址，所以，类似resolveId这种就是解析文件地址的意思。从<code>inputOption</code>的<code>input</code>配置指定的入口文件开始，每当匹配到引入外部模块的语句(如：<code>import moudleA from &#39;./moduleA&#39;</code>)便依次执行注册插件中的每一个 <code>resolveId</code> 钩子，直到某一个插件中的 <code>resolveId</code> 执行完后返回非 <code>null</code> 或非 <code>undefined</code> 的值，将停止执行后续插件的 <code>resolveId</code> 逻辑并进入下一个钩子</li><li>调用<code>load</code>钩子加载模块内容，<code>resolveId</code>中的路径一般为相对路径，load中的路径为处理之后的绝对路径</li><li>接着判断当前解析的模块是否存在缓存，若不存在则执行所有的 <code>transform</code> 钩子来对模块内容进行进行自定义的转换；若存在则判断<code>shouldTransformCachedModule</code>属性，true则执行所有的 <code>transform</code> 钩子，false则进入<code>moduleParsed</code>钩子逻辑</li><li>拿到最后的模块内容，进行 <code>AST</code> 分析，调用 <code>moduleParsed</code> 钩子。如果内部没有<code>imports</code>内容，进入<code>buildEnd</code>环节。如果还有<code>imports</code>内容则继续，如果是普通的 <code>import</code>，则执行<code>resolveId</code> 钩子，继续回到<strong>步骤3-调用resolveId</strong>；如果是动态 <code>import</code>，则执行<code>resolveDynamicImport</code> 钩子解析路径，如果解析成功，则回到<strong>步骤4-load</strong>加载模块，否则回到步骤3通过 <code>resolveId</code> 解析路径</li><li>直到所有的 <code>import</code> 都解析完毕，<code>Rollup</code> 执行<code>buildEnd</code>钩子，Build阶段结束</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token comment">// rollup-plugin-example.js</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">myExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;my-example&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">options</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🎉 -- options:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">buildStart</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;✨ -- buildStart:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">resolveId</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span>importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🚀 -- resolveId(source):&quot;</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🚀 -- resolveId(importer):&quot;</span><span class="token punctuation">,</span> importer<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">load</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🌈 ~ id:&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span>id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🌟 -- transform&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;---&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;---&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">moduleParsed</span> <span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;⭐️ -- moduleParsed:&quot;</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">buildEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;😁 -- buildEnd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="调用虚拟模块插件示例" tabindex="-1"><a class="header-anchor" href="#调用虚拟模块插件示例"><span>调用虚拟模块插件示例</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> virtualModuleId <span class="token operator">=</span> <span class="token string">&#39;virtual-module&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// rollup约定插件使用“虚拟模块”，使用\0前缀模块 ID。这可以防止其他插件尝试处理它。</span></span>
<span class="line"><span class="token keyword">const</span> resolvedVirtualModuleId <span class="token operator">=</span> <span class="token string">&#39;\0&#39;</span> <span class="token operator">+</span> virtualModuleId<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">virtualModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;virtual-module&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">    <span class="token function">resolveId</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token string">&#39;virtual-module&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token keyword">return</span> resolvedVirtualModuleId<span class="token punctuation">;</span> <span class="token comment">// 告诉Rollup，这个ID是外部模块，不要在此处查找它</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 其他ID应按通常方式处理</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">load</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🌈 - id:&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> resolvedVirtualModuleId<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token comment">// return &#39;export default &quot;This is virtual!&quot;&#39;; // 告诉Rollup，如何加载此模块</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&#39;export default function fib(n) { return n &lt;= 1 ? n : fib(n - 1) + fib(n - 2); }&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 其他ID应按通常方式处理</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>界面调用</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> fib <span class="token keyword">from</span> <span class="token string">&quot;virtual-module&quot;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="json插件示例" tabindex="-1"><a class="header-anchor" href="#json插件示例"><span>JSON插件示例</span></a></h4><p>rollup默认是不能直接读取json文件的内容的，我们自己写一个插件处理一下，不过写这个插件之前，有一些小知识点需要补充一下</p><p><a href="https://github.com/rollup/plugins/tree/master/packages/pluginutils" target="_blank" rel="noopener noreferrer">@rollup/pluginutils</a> rollup官方提供的工具插件,里面有一些制作插件常用的方法</p><p><strong>安装</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">pnpm add @rollup<span class="token operator">/</span>plugin<span class="token operator">-</span>commonjs @rollup<span class="token operator">/</span>plugin<span class="token operator">-</span>node<span class="token operator">-</span>resolve @rollup<span class="token operator">/</span>pluginutils <span class="token operator">-</span><span class="token constant">D</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><a href="https://cn.rollupjs.org/plugin-development/#plugin-context" target="_blank" rel="noopener noreferrer">插件上下文</a></p><p>这个其实也是插件中很常用的一些api，可以通过 <code>this</code> 从大多数<a href="https://cn.rollupjs.org/plugin-development/#build-hooks" target="_blank" rel="noopener noreferrer">钩子</a>中访问一些实用函数和信息位</p><p><strong>rollup-plugin-json</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createFilter<span class="token punctuation">,</span>dataToEsm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@rollup/pluginutils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">myJson</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// createFilter 返回一个函数，这个函数接收一个id路径参数，返回一个布尔值</span></span>
<span class="line">  <span class="token comment">// 这个布尔值表示是否要处理这个id路径</span></span>
<span class="line">  <span class="token comment">// rollup 推荐每一个 transform 类型的插件都需要提供 include 和 exclude 选项，生成过滤规则</span></span>
<span class="line">  <span class="token keyword">const</span> filter <span class="token operator">=</span> <span class="token function">createFilter</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>include<span class="token punctuation">,</span> options<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;rollup-plugin-json&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token string">&quot;pre&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">filter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&#39;.json&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">const</span> parse <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// dataToEsm 将数据转换成esm模块</span></span>
<span class="line">            <span class="token comment">// 其实就是 export default &quot;xxx&quot;</span></span>
<span class="line">            <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token function">dataToEsm</span><span class="token punctuation">(</span>parse<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">            <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">          <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">&#39;Could not parse JSON file&#39;</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token literal-property property">cause</span><span class="token operator">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>界面调用</strong></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> pkg <span class="token keyword">from</span> <span class="token string">&quot;../package.json&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> test <span class="token keyword">from</span> <span class="token string">&quot;../test.json&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 错误json格式演示</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="插件上下文" tabindex="-1"><a class="header-anchor" href="#插件上下文"><span><a href="https://cn.rollupjs.org/plugin-development/#plugin-context" target="_blank" rel="noopener noreferrer">插件上下文</a></span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@rollup/pluginutils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">customPlugin</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> filter <span class="token operator">=</span> <span class="token function">createFilter</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>include<span class="token punctuation">,</span> options<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;custom-plugin&#39;</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">filter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> parsedCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析代码,获取AST</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>parsedCode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> fileName <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>emitFile<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;asset&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">fileName</span><span class="token operator">:</span> fileName <span class="token operator">+</span> <span class="token string">&#39;.txt&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          source<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图片读取" tabindex="-1"><a class="header-anchor" href="#图片读取"><span>图片读取</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createFilter<span class="token punctuation">,</span>dataToEsm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@rollup/pluginutils&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> extname<span class="token punctuation">,</span>resolve<span class="token punctuation">,</span>basename<span class="token punctuation">,</span>relative<span class="token punctuation">,</span>normalize<span class="token punctuation">,</span>sep <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">&quot;fs&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> svgToMiniDataURI <span class="token keyword">from</span> <span class="token string">&quot;mini-svg-data-uri&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> defaults <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">fileSize</span><span class="token operator">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&quot;./dist&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> mimeTypes <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;.png&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/png&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.jpg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.jpeg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/jpeg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.gif&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/gif&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.svg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/svg+xml&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.ico&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/x-icon&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.webp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/webp&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;.avif&quot;</span><span class="token operator">:</span> <span class="token string">&quot;image/avif&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getDataUri</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> format<span class="token punctuation">,</span> isSvg<span class="token punctuation">,</span> mime<span class="token punctuation">,</span> source <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">  isSvg <span class="token operator">?</span> <span class="token function">svgToMiniDataURI</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>format<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">ensureDirExists</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dirPath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> </span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token comment">// 文件夹不存在就创建文件夹</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>dirPath<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">myImage</span><span class="token punctuation">(</span><span class="token parameter">opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">  <span class="token keyword">const</span> options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaults<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> filter <span class="token operator">=</span> <span class="token function">createFilter</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>include<span class="token punctuation">,</span> options<span class="token punctuation">.</span>exclude<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;my-image&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">filter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// 获取后缀</span></span>
<span class="line">      <span class="token keyword">const</span> ext <span class="token operator">=</span> <span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 判断是否是图片</span></span>
<span class="line">      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>mimeTypes<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">// 获取图片的mime类型</span></span>
<span class="line">      <span class="token keyword">const</span> mime <span class="token operator">=</span> mimeTypes<span class="token punctuation">[</span>ext<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 判断是否svg</span></span>
<span class="line">      <span class="token keyword">const</span> isSvg <span class="token operator">=</span> mime <span class="token operator">===</span> mimeTypes<span class="token punctuation">[</span><span class="token string">&quot;.svg&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 图片format格式</span></span>
<span class="line">      <span class="token keyword">const</span> format <span class="token operator">=</span> isSvg <span class="token operator">?</span> <span class="token string">&quot;utf-8&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;base64&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">// 目标路径</span></span>
<span class="line">      <span class="token keyword">const</span> assetsPath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;---&quot;</span><span class="token punctuation">,</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;---&quot;</span><span class="token punctuation">,</span>options<span class="token punctuation">.</span>target<span class="token punctuation">)</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;---&quot;</span><span class="token punctuation">,</span> assetsPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">//获取文件名</span></span>
<span class="line">      <span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token function">basename</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 最终文件路径</span></span>
<span class="line">      <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>assetsPath<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;===&quot;</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">let</span> relativePath <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">relative</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      relativePath <span class="token operator">=</span> relativePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>sep<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 如果图片文件过大，就应该直接拷贝文件，返回文件路径</span></span>
<span class="line">        <span class="token comment">// 读取图片文件大小与设置的大小进行比较</span></span>
<span class="line">        <span class="token keyword">const</span> stat <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> options<span class="token punctuation">.</span>fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// 文件的拷贝，以及对象的返回</span></span>
<span class="line">          <span class="token comment">// 文件拷贝，无非就是文件源路径，目标路径</span></span>
<span class="line">          <span class="token comment">//copyFile 拷贝文件地址的文件夹必须存在</span></span>
<span class="line">          <span class="token comment">// 如果文件夹不存在，那么就创建文件夹</span></span>
<span class="line">          <span class="token keyword">const</span> dirExists <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ensureDirExists</span><span class="token punctuation">(</span>assetsPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          dirExists <span class="token operator">&amp;&amp;</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token function">dataToEsm</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//返回拷贝之后处理的路径</span></span>
<span class="line">            <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">// 否则转换为base64格式</span></span>
<span class="line">          <span class="token comment">// 读取文件</span></span>
<span class="line">          <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">          <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token function">dataToEsm</span><span class="token punctuation">(</span><span class="token function">getDataUri</span><span class="token punctuation">(</span><span class="token punctuation">{</span> format<span class="token punctuation">,</span> isSvg<span class="token punctuation">,</span> mime<span class="token punctuation">,</span> source <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">&quot;图片转换失败:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token literal-property property">cause</span><span class="token operator">:</span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="输出钩子执行顺序" tabindex="-1"><a class="header-anchor" href="#输出钩子执行顺序"><span>输出钩子执行顺序</span></a></h3><p><img src="/smile-website/images/rollup/image-20230920110457237.png" alt="image-20230920110457237"></p><ol><li>执行所有插件的 <code>outputOptions</code> 钩子函数，对 <code>output</code> 配置进行转换</li><li>执行 <code>renderStart</code>，该钩子读取所有outputOptions钩子的转换之后的输出选项</li><li>扫描 <code>动态import</code> 语句执行 <code>renderDynamicImport</code> 钩子，让开发者能自定义<code>动态import</code>的内容与行为</li><li>并发执行所有插件的 <code>banner、footer、intro、outro</code> 钩子，这四个钩子功能简单，就是往打包产物的固定位置(比如头部和尾部)插入一些自定义的内容，比如版本号、作者、内容、项目介绍等等</li><li>是否存在 <code>import.meta</code> 语句，没有就直接进入下一步，否则：对于<code>import.meta.url</code>调用 <code>resolveFileUrl</code> 来自定义 url 解析逻辑。对于<code>import.meta</code>调用 <code>resolveImportMeta</code> 来进行自定义元信息解析</li><li>生成chunk调用<code>renderChunk</code>钩子，便于在该钩子中进行自定义操作。如果生成的chunk文件有hash值，执行 <code>augmentChunkHash</code> 钩子，来决定是否更改 <code>chunk</code> 的哈希值。</li><li>调用 <code>generateBundle</code> 钩子，这个钩子的入参里面会包含所有的打包产物信息，包括 <code>chunk</code> (打包后的代码)、<code>asset</code>(最终的静态资源文件)。在这个钩子中你做自定义自己的操作，比如：可以在这里删除一些 <code>chunk</code> 或者 <code>asset</code>，最终被删除的内容将不会作为产物输出</li><li>上节课讲解的javascript api---<code>rollup.rollup</code>方法会返回一个<code>bundle</code>对象，<code>bundle</code>对象的write方法，会触发<code>writeBundle</code>钩子，传入所有的打包产物信息，包括 <code>chunk</code> 和 <code>asset</code>，与<code>generateBundle</code>钩子非常相似。唯一的区别是<code>writeBundle</code>钩子执行的时候，产物已经输出了。而 <code>generateBundle</code> 执行的时候产物还并没有输出。简单来说，顺序是：<code>generateBundle---&gt;输出并保存产物到磁盘---&gt;writeBundle</code></li><li>当<code>bundle</code>的<code>close</code>方法被调用时，会触发<code>closeBundle</code>钩子，这个output阶段结束</li></ol><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">myExample2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;my-example2&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">outputOptions</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🎉 ~ options:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderStart</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;✨ ~ renderStart:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderDynamicImport</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;✨~ renderDynamicImport:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">banner</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🔥 ~ banner(chunk):&quot;</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">const</span> comment <span class="token operator">=</span> chunk<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;index&quot;</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/*</span>
<span class="line">* </span>
<span class="line">* 　　┏┓　　　┏┓+ +</span>
<span class="line">* 　┏┛┻━━━┛┻┓ + +</span>
<span class="line">* 　┃　　　　　　　┃ 　</span>
<span class="line">* 　┃　　　━　　　┃ ++ + + +</span>
<span class="line">*  ████━████ ┃+</span>
<span class="line">* 　┃　　　　　　　┃ +</span>
<span class="line">* 　┃　　　┻　　　┃</span>
<span class="line">* 　┃　　　　　　　┃ + +</span>
<span class="line">* 　┗━┓　　　┏━┛</span>
<span class="line">* 　　　┃　　　┃　　　　　　　　　　　</span>
<span class="line">* 　　　┃　　　┃ + + + +</span>
<span class="line">* 　　　┃　　　┃</span>
<span class="line">* 　　　┃　　　┃ +  神兽保佑</span>
<span class="line">* 　　　┃　　　┃    代码无bug　　</span>
<span class="line">* 　　　┃　　　┃　　+　　　　　　　　　</span>
<span class="line">* 　　　┃　 　　┗━━━┓ + +</span>
<span class="line">* 　　　┃ 　　　　　　　┣┓</span>
<span class="line">* 　　　┃ 　　　　　　　┏┛</span>
<span class="line">* 　　　┗┓┓┏━┳┓┏┛ + + + +</span>
<span class="line">* 　　　　┃┫┫　┃┫┫</span>
<span class="line">* 　　　　┗┻┛　┗┻┛+ + + +</span>
<span class="line">* </span>
<span class="line">*/</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> comment<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderChunk</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🚀 ~ source:&quot;</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">augmentChunkHash</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🎉 ~ augmentChunkHash:&quot;</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">generateBundle</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> bundle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🌈 ~ options:&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🌈 ~ bundle:&quot;</span><span class="token punctuation">,</span> bundle<span class="token punctuation">)</span></span>
<span class="line">      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;sum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">          <span class="token comment">//删除对象中的这个键值对</span></span>
<span class="line">          <span class="token keyword">delete</span> bundle<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">closeBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;😁 ~ closeBundle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="打包大小和时间示例" tabindex="-1"><a class="header-anchor" href="#打包大小和时间示例"><span>打包大小和时间示例：</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">bundleStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> startTime<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;bundle-stats&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">generateBundle</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> bundle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> fileSizes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>fileName<span class="token punctuation">,</span> output<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>output<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;chunk&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">const</span> content <span class="token operator">=</span> output<span class="token punctuation">.</span>code<span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">const</span> size <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">const</span> sizeInKB <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">          fileSizes<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sizeInKB<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> KB</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Bundle Stats:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;-------------&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;File Sizes:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fileSizes<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;-------------&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">closeBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> totalTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Total Bundle Time: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>totalTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;-------------&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="代码压缩" tabindex="-1"><a class="header-anchor" href="#代码压缩"><span>代码压缩</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> minify <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;uglify-js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">uglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;uglify&#39;</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">renderChunk</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">minify</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">minify error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">code</span><span class="token operator">:</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">mappings</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: gang.peng@szyh.com">gang.peng</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/smile-website/assets/app-DzEwyuga.js" defer></script>
  </body>
</html>
